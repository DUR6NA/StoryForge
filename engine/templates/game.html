<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryForge Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        .typing-effect::after {
            content: '|';
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#ec4899',
                        dark: '#0f172a',
                        surface: '#1e293b',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-black text-gray-100 font-sans h-screen flex flex-col overflow-hidden" x-data="game()">

    <!-- Top HUD -->
    <header
        class="h-14 bg-surface/80 backdrop-blur border-b border-gray-800 flex items-center justify-between px-6 z-10">
        <div class="flex items-center gap-4">
            <div class="flex flex-col">
                <span class="font-bold text-lg leading-tight" x-text="data.location?.name || 'Unknown'"></span>
                <span class="text-xs text-gray-400" x-text="data.state?.time?.display"></span>
            </div>
        </div>

        <div class="flex items-center gap-6 text-sm font-medium">
            <div class="flex items-center gap-2 text-yellow-400">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z">
                    </path>
                </svg>
                <span x-text="data.state?.player?.gold + ' G'"></span>
            </div>
            <div class="flex items-center gap-2 text-red-400">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                        clip-rule="evenodd"></path>
                </svg>
                <span x-text="data.state?.player?.health + '/' + data.state?.player?.max_health"></span>
            </div>
        </div>
    </header>

    <!-- Main Viewport -->
    <main class="flex-1 relative flex">

        <!-- Background Image -->
        <div class="absolute inset-0 z-0">
            <template x-if="data.location?.image">
                <img :src="data.location.image" class="w-full h-full object-cover opacity-30">
            </template>
            <div class="absolute inset-0 bg-gradient-to-t from-dark via-dark/80 to-transparent"></div>
        </div>

        <!-- Content Container -->
        <div class="relative z-10 container mx-auto px-4 py-8 flex flex-col justify-end h-full max-w-4xl">

            <!-- Text Output Box -->
            <div
                class="mb-8 bg-surface/80 backdrop-blur-sm border border-gray-700/50 rounded-xl p-6 shadow-lg min-h-[180px] max-h-[300px] overflow-y-auto">
                <div class="prose prose-invert max-w-none text-lg leading-relaxed text-gray-200"
                    x-html="data.location?.description"></div>
            </div>

            <!-- Choices -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <template x-for="(choice, index) in data.location?.choices" :key="index">
                    <button @click="makeChoice(choice)"
                        class="bg-surface/90 hover:bg-primary/90 hover:scale-[1.02] border border-gray-700 hover:border-primary transition-all p-4 rounded-lg text-left group">
                        <span class="font-semibold block group-hover:text-white" x-text="choice.text"></span>
                    </button>
                </template>
            </div>

        </div>
    </main>

    <!-- Bottom Bar -->
    <footer class="h-12 bg-darker border-t border-gray-800 flex items-center justify-center gap-2">
        <button @click="showInventory = true"
            class="px-4 py-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white text-sm transition-colors">Inventory</button>
        <button @click="showQuests = true"
            class="px-4 py-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white text-sm transition-colors">Quests</button>
        <button @click="showGallery = true"
            class="px-4 py-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white text-sm transition-colors">Gallery</button>
        <div class="w-px h-4 bg-gray-700 mx-2"></div>
        <button @click="showMenu = true"
            class="px-4 py-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white text-sm transition-colors">Menu
            (Esc)</button>
    </footer>

    <!-- Modals -->

    <!-- Inventory Modal -->
    <div x-show="showInventory" @keydown.window.escape="showInventory = false"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-surface border border-gray-700 p-6 rounded-xl w-[500px] max-h-[80vh] shadow-2xl flex flex-col">
            <h3 class="text-xl font-bold mb-4 text-primary flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                Inventory
            </h3>
            <div class="flex-1 overflow-y-auto">
                <template x-if="data.state?.player?.inventory && data.state.player.inventory.length > 0">
                    <div class="grid grid-cols-3 gap-3">
                        <template x-for="(item, index) in data.state.player.inventory" :key="index">
                            <div
                                class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 hover:border-primary transition-colors cursor-pointer">
                                <div class="text-sm font-medium" x-text="item.name || item"></div>
                                <div class="text-xs text-gray-400" x-text="item.description || ''"></div>
                            </div>
                        </template>
                    </div>
                </template>
                <template x-if="!data.state?.player?.inventory || data.state.player.inventory.length === 0">
                    <div class="text-center text-gray-500 py-8">Your inventory is empty.</div>
                </template>
            </div>
            <button @click="showInventory = false"
                class="mt-6 w-full border border-gray-600 py-2 rounded hover:bg-gray-800 transition-colors">Close</button>
        </div>
    </div>

    <!-- Quests Modal -->
    <div x-show="showQuests" @keydown.window.escape="showQuests = false"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-surface border border-gray-700 p-6 rounded-xl w-[500px] max-h-[80vh] shadow-2xl flex flex-col">
            <h3 class="text-xl font-bold mb-4 text-yellow-400 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                    </path>
                </svg>
                Quests
            </h3>
            <div class="flex-1 overflow-y-auto">
                <template x-if="data.state?.quests && Object.keys(data.state.quests).length > 0">
                    <div class="space-y-3">
                        <template x-for="(quest, questId) in data.state.quests" :key="questId">
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-white" x-text="quest.name || questId"></span>
                                    <span class="text-xs px-2 py-1 rounded"
                                        :class="quest.completed ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'"
                                        x-text="quest.completed ? 'Completed' : 'In Progress'"></span>
                                </div>
                                <p class="text-sm text-gray-400"
                                    x-text="quest.description || 'No description available.'"></p>
                            </div>
                        </template>
                    </div>
                </template>
                <template x-if="!data.state?.quests || Object.keys(data.state.quests).length === 0">
                    <div class="text-center text-gray-500 py-8">No active quests.</div>
                </template>
            </div>
            <button @click="showQuests = false"
                class="mt-6 w-full border border-gray-600 py-2 rounded hover:bg-gray-800 transition-colors">Close</button>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div x-show="showGallery" @keydown.window.escape="showGallery = false"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-surface border border-gray-700 p-6 rounded-xl w-[600px] max-h-[80vh] shadow-2xl flex flex-col">
            <h3 class="text-xl font-bold mb-4 text-secondary flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                Gallery
            </h3>
            <div class="flex-1 overflow-y-auto">
                <template x-if="data.state?.gallery && data.state.gallery.length > 0">
                    <div class="grid grid-cols-3 gap-3">
                        <template x-for="(image, index) in data.state.gallery" :key="index">
                            <div
                                class="aspect-square bg-gray-800 rounded-lg overflow-hidden border border-gray-700 hover:border-secondary transition-colors cursor-pointer">
                                <img :src="image.src || image" class="w-full h-full object-cover"
                                    :alt="image.title || 'Gallery Image'">
                            </div>
                        </template>
                    </div>
                </template>
                <template x-if="!data.state?.gallery || data.state.gallery.length === 0">
                    <div class="text-center text-gray-500 py-8">No images unlocked yet.</div>
                </template>
            </div>
            <button @click="showGallery = false"
                class="mt-6 w-full border border-gray-600 py-2 rounded hover:bg-gray-800 transition-colors">Close</button>
        </div>
    </div>

    <!-- Menu Modal -->
    <div x-show="showMenu" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
        x-cloak x-transition>
        <div class="bg-surface border border-gray-700 p-6 rounded-xl w-96 shadow-2xl">
            <h3 class="text-xl font-bold mb-6 text-white text-center">Game Menu</h3>
            <div class="space-y-3">
                <button @click="showMenu = false; showSaveLoad = true; saveLoadMode = 'save'; loadSavesList()"
                    class="w-full bg-primary/20 hover:bg-primary/40 border border-primary/50 py-3 rounded-lg flex items-center justify-center gap-2 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                        </path>
                    </svg>
                    Save Game
                </button>
                <button @click="showMenu = false; showSaveLoad = true; saveLoadMode = 'load'; loadSavesList()"
                    class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-lg flex items-center justify-center gap-2 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Load Game
                </button>
                <button @click="showSettings()"
                    class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-lg flex items-center justify-center gap-2 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Settings
                </button>
                <div class="border-t border-gray-700 my-4"></div>
                <button @click="exitToLauncher()"
                    class="w-full bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 text-red-400 py-3 rounded-lg flex items-center justify-center gap-2 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    Exit to Launcher
                </button>
            </div>
            <button @click="showMenu = false"
                class="mt-6 w-full border border-gray-600 py-2 rounded hover:bg-gray-800 transition-colors">Close</button>
        </div>
    </div>

    <!-- Save/Load Modal -->
    <div x-show="showSaveLoad" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
        x-cloak x-transition>
        <div class="bg-surface border border-gray-700 p-6 rounded-xl w-[500px] max-h-[80vh] shadow-2xl flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            x-show="saveLoadMode === 'save'"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            x-show="saveLoadMode === 'load'"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    <span x-text="saveLoadMode === 'save' ? 'Save Game' : 'Load Game'"></span>
                </h3>
                <div class="flex gap-2">
                    <button @click="saveLoadMode = 'save'; loadSavesList()"
                        :class="saveLoadMode === 'save' ? 'bg-primary text-white' : 'bg-gray-700 text-gray-400'"
                        class="px-3 py-1 rounded text-sm transition-colors">Save</button>
                    <button @click="saveLoadMode = 'load'; loadSavesList()"
                        :class="saveLoadMode === 'load' ? 'bg-primary text-white' : 'bg-gray-700 text-gray-400'"
                        class="px-3 py-1 rounded text-sm transition-colors">Load</button>
                </div>
            </div>

            <!-- Quick Save/New Save Section -->
            <template x-if="saveLoadMode === 'save'">
                <div class="mb-4 space-y-2">
                    <button @click="quickSave()"
                        class="w-full bg-green-500/20 hover:bg-green-500/40 border border-green-500/50 text-green-400 py-2 rounded-lg flex items-center justify-center gap-2 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Quick Save
                    </button>
                    <div class="flex gap-2">
                        <input type="text" x-model="newSaveSlotName" placeholder="Enter save name..."
                            class="flex-1 bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm focus:border-primary focus:outline-none">
                        <button @click="saveToSlot(newSaveSlotName)"
                            class="bg-primary hover:bg-primary/80 px-4 py-2 rounded text-sm transition-colors">Save</button>
                    </div>
                </div>
            </template>

            <!-- Saves List -->
            <div class="flex-1 overflow-y-auto mb-4">
                <template x-if="savesList.length > 0">
                    <div class="space-y-2">
                        <template x-for="(save, index) in savesList" :key="save.slot">
                            <div
                                class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 hover:border-primary transition-colors flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-medium text-white" x-text="save.slot"></div>
                                    <div class="text-xs text-gray-400" x-text="formatTimestamp(save.timestamp)"></div>
                                </div>
                                <div class="flex gap-2">
                                    <template x-if="saveLoadMode === 'save'">
                                        <button @click="saveToSlot(save.slot)"
                                            class="bg-primary/20 hover:bg-primary/40 border border-primary/50 px-3 py-1 rounded text-sm transition-colors">Overwrite</button>
                                    </template>
                                    <template x-if="saveLoadMode === 'load'">
                                        <button @click="loadFromSlot(save.slot)"
                                            class="bg-green-500/20 hover:bg-green-500/40 border border-green-500/50 text-green-400 px-3 py-1 rounded text-sm transition-colors">Load</button>
                                    </template>
                                    <button @click="deleteSave(save.slot)"
                                        class="bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 text-red-400 px-2 py-1 rounded text-sm transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                <template x-if="savesList.length === 0">
                    <div class="text-center text-gray-500 py-8">
                        <template x-if="saveLoadMode === 'load'">
                            <span>No save files found.</span>
                        </template>
                        <template x-if="saveLoadMode === 'save'">
                            <span>No existing saves. Create your first save above!</span>
                        </template>
                    </div>
                </template>
            </div>

            <!-- Export/Import Section -->
            <div class="border-t border-gray-700 pt-4 space-y-2">
                <div class="text-xs text-gray-400 mb-2">Export & Import Saves</div>
                <div class="flex gap-2">
                    <button @click="exportSave()"
                        class="flex-1 bg-blue-500/20 hover:bg-blue-500/40 border border-blue-500/50 text-blue-400 py-2 rounded-lg flex items-center justify-center gap-2 transition-colors text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Export to File
                    </button>
                    <button @click="$refs.importFileInput.click()"
                        class="flex-1 bg-purple-500/20 hover:bg-purple-500/40 border border-purple-500/50 text-purple-400 py-2 rounded-lg flex items-center justify-center gap-2 transition-colors text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Import from File
                    </button>
                    <input type="file" x-ref="importFileInput" @change="importSave($event)" accept=".json"
                        class="hidden">
                </div>
            </div>

            <button @click="showSaveLoad = false"
                class="mt-4 w-full border border-gray-600 py-2 rounded hover:bg-gray-800 transition-colors">Close</button>
        </div>
    </div>

    <!-- Cheat Menu (F1) -->
    <div x-show="showCheatMenu" @keydown.window.f1.prevent="showCheatMenu = !showCheatMenu"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-surface border border-gray-700 p-6 rounded-xl w-96 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-primary">Cheat Menu</h3>
            <div class="space-y-2">
                <button @click="cheat('give_gold 1000')" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded">Give
                    1000 Gold</button>
                <button @click="cheat('heal_player 100')" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded">Full
                    Heal</button>
                <button @click="cheat('teleport start')"
                    class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded">Teleport to Start</button>
            </div>
            <button @click="showCheatMenu = false"
                class="mt-6 w-full border border-gray-600 py-2 rounded hover:bg-gray-800">Close</button>
        </div>
    </div>

    <!-- Console (F2) -->
    <div x-show="showConsole" @keydown.window.f2.prevent="showConsole = !showConsole"
        class="fixed inset-x-0 bottom-0 z-50 bg-black/90 border-t border-gray-700 p-4" x-cloak x-transition>
        <div class="container mx-auto">
            <div class="h-32 overflow-y-auto font-mono text-xs text-gray-400 mb-2" id="console-log">
                <div>> System initialized.</div>
            </div>
            <input type="text" @keydown.enter="runConsoleCommand($el.value); $el.value = ''"
                placeholder="Enter command..."
                class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 font-mono text-sm focus:border-primary focus:outline-none">
        </div>
    </div>

    <script>
        function game() {
            return {
                gameId: window.location.pathname.split('/').pop(),
                data: {},
                showCheatMenu: false,
                showConsole: false,
                showInventory: false,
                showQuests: false,
                showGallery: false,
                showMenu: false,
                showSaveLoad: false,
                saveLoadMode: 'save', // 'save' or 'load'
                savesList: [],
                newSaveSlotName: '',

                async init() {
                    await this.refreshState();
                    // Listen for Escape key to open menu
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && !this.showInventory && !this.showQuests && !this.showGallery && !this.showCheatMenu && !this.showConsole && !this.showSaveLoad) {
                            this.showMenu = !this.showMenu;
                        }
                    });
                },

                async refreshState() {
                    try {
                        const res = await fetch(`/api/game/${this.gameId}/state`);
                        this.data = await res.json();
                    } catch (e) {
                        console.error(e);
                    }
                },

                async makeChoice(choice) {
                    try {
                        await fetch(`/api/game/${this.gameId}/action`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(choice)
                        });
                        await this.refreshState();
                    } catch (e) {
                        console.error(e);
                    }
                },

                async cheat(cmd) {
                    // We treat cheats as function calls
                    const parts = cmd.split(' ');
                    await this.makeChoice({
                        type: 'function',
                        action: cmd,
                        text: 'Cheat: ' + cmd
                    });
                    this.showCheatMenu = false;
                },

                async runConsoleCommand(cmd) {
                    const log = document.getElementById('console-log');
                    log.innerHTML += `<div>> ${cmd}</div>`;
                    await this.cheat(cmd);
                    log.scrollTop = log.scrollHeight;
                },

                // Save/Load Functions
                async loadSavesList() {
                    try {
                        const res = await fetch(`/api/game/${this.gameId}/saves`);
                        const data = await res.json();
                        this.savesList = data.saves || [];
                    } catch (e) {
                        console.error('Failed to load saves list:', e);
                        this.savesList = [];
                    }
                },

                async quickSave() {
                    await this.saveToSlot('quicksave');
                },

                async saveToSlot(slot) {
                    if (!slot || slot.trim() === '') {
                        alert('Please enter a save name.');
                        return;
                    }
                    // Sanitize slot name
                    slot = slot.trim().replace(/[^a-zA-Z0-9_-]/g, '_');

                    try {
                        const res = await fetch(`/api/game/${this.gameId}/save?slot=${encodeURIComponent(slot)}`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.newSaveSlotName = '';
                            await this.loadSavesList();
                            alert('Game saved successfully!');
                        } else {
                            const error = await res.json();
                            alert('Failed to save: ' + (error.detail || 'Unknown error'));
                        }
                    } catch (e) {
                        console.error('Save error:', e);
                        alert('Error saving game.');
                    }
                },

                async loadFromSlot(slot) {
                    try {
                        const res = await fetch(`/api/game/${this.gameId}/load?slot=${encodeURIComponent(slot)}`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            await this.refreshState();
                            this.showSaveLoad = false;
                            alert('Game loaded successfully!');
                        } else {
                            const error = await res.json();
                            alert('Failed to load: ' + (error.detail || 'Save file not found'));
                        }
                    } catch (e) {
                        console.error('Load error:', e);
                        alert('Error loading game.');
                    }
                },

                async deleteSave(slot) {
                    if (!confirm(`Are you sure you want to delete the save "${slot}"?`)) {
                        return;
                    }
                    try {
                        const res = await fetch(`/api/game/${this.gameId}/save/${encodeURIComponent(slot)}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            await this.loadSavesList();
                        } else {
                            alert('Failed to delete save.');
                        }
                    } catch (e) {
                        console.error('Delete error:', e);
                        alert('Error deleting save.');
                    }
                },

                async exportSave() {
                    try {
                        const res = await fetch(`/api/game/${this.gameId}/export`);
                        if (res.ok) {
                            const saveData = await res.json();
                            const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${this.gameId}_save_${new Date().toISOString().slice(0, 10)}.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        } else {
                            alert('Failed to export save.');
                        }
                    } catch (e) {
                        console.error('Export error:', e);
                        alert('Error exporting save.');
                    }
                },

                async importSave(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const saveData = JSON.parse(text);

                        const res = await fetch(`/api/game/${this.gameId}/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(saveData)
                        });

                        if (res.ok) {
                            await this.refreshState();
                            this.showSaveLoad = false;
                            alert('Save imported successfully!');
                        } else {
                            const error = await res.json();
                            alert('Failed to import: ' + (error.detail || 'Invalid save file'));
                        }
                    } catch (e) {
                        console.error('Import error:', e);
                        alert('Error importing save. Make sure the file is a valid save file.');
                    }

                    // Reset file input
                    event.target.value = '';
                },

                formatTimestamp(timestamp) {
                    if (!timestamp) return 'Unknown date';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString();
                },

                showSettings() {
                    alert('Settings panel coming soon!');
                    this.showMenu = false;
                },

                exitToLauncher() {
                    if (confirm('Are you sure you want to exit? Unsaved progress will be lost.')) {
                        window.location.href = '/launcher';
                    }
                }
            }
        }
    </script>
</body>

</html>